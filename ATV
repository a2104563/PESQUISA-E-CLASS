#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void LIMPAR(char *s){   //Funcao para limpar espacos vazios da string, fazendo um registro de tamanho variavel, para evitar perde de memoria!
    int  i,k=0;
    for(i=0;s[i];i++){
        s[i]=s[i+k];
        if(s[i]==' '&&s[i+1]==' '){ //Condicao para limpar apenas espacos vazios, e nao tirar todos os espacos!
            k++;
            i--;
        }
    }
}




typedef struct cadastro {   //Struct Cadastro
    int RRN;
    char ID[4];
    char nome[25];
    char rua[25];
    char cidade[20];
    char UF[2];
    char IP[5];
}cad;

typedef struct cadastroOrdenado {
    int RRN;
    char nome[25];
}CadOrder;

int compararNome (const void *a, const void *b) {
    return strcmp (((CadOrder *)a)->nome,((CadOrder *)b)->nome);
}

//------------------------------ INDICE PRIMARIO -> COMBINACAO DE UF+ID------------------------------------------------
void CriarIndicePrimario(cad *Pessoas){
    FILE *arqIP;
    arqIP= fopen("C://Users/Lucas/Documents/Clion/Pc_Indexacao/IndicePrimario.txt", "a+");

    if (arqIP ==NULL ) {
        printf("ERRO! ARQUIVO DE INDICE PRIMARIO INEXISTENTE! \n");
        printf("Criando novo arquivo de indice... \n");
        arqIP = fopen("C://Users/Lucas/Documents/Clion/Pc_Indexacao/IndicePrimario.txt", "w");
        // Cria novo arq caso nao exista
    }

    int cont=0;
    while (cont<10){
        int k=0;

        for(int i = 0; i <= 5; i++){
            if(i < 2){
                Pessoas[cont].IP[i] = Pessoas[cont].UF[i];
            }
            else{
              Pessoas[cont].IP[i]= Pessoas[cont].ID[k];
              k++;
            }
        }//concatena UF + ID = INDICE PRIMARIO

        fwrite(Pessoas[cont].IP, sizeof(char), strlen(Pessoas[cont].IP) , arqIP); // Escreve INDICE PRIMARIO NO ARQ
        fprintf(arqIP,"|%d\n",Pessoas[cont].RRN); // ESCREVE RRN NO ARQ
        cont++;
    }
    cont =0;
    fclose(arqIP);

};

void CriarIndiceSecundario(cad *Pessoas){
    FILE *arqIS_Cidade;
    FILE *arqIS_Nome;
    arqIS_Cidade= fopen("C://Users/Lucas/Documents/Clion/Pc_Indexacao/IndiceSecundario_Cidade.txt", "a+");
    arqIS_Nome= fopen("C://Users/Lucas/Documents/Clion/Pc_Indexacao/IndiceSecundario_Nome.txt", "a+");

    if (arqIS_Cidade ==NULL && arqIS_Nome == NULL){
        printf("ERRO! ARQUIVOS DE INDICE SECUNDARIO INEXISTENTE! \n");
        printf("Criando novos arquivo de indices... \n");
        arqIS_Cidade = fopen("C://Users/Lucas/Documents/Clion/Pc_Indexacao/IndiceSecundario_Cidade.txt", "w");
        arqIS_Nome = fopen("C://Users/Lucas/Documents/Clion/Pc_Indexacao/IndiceSecundario_Nome.txt", "w");
    }

    int i = 0;
    while(i < 10){
        //----------------------------  Cidade fracamente ligado -------------------------------------------------------
        fwrite(Pessoas[i].cidade, sizeof(char),strlen(Pessoas[i].cidade), arqIS_Cidade);
        fprintf(arqIS_Cidade,"|");
        fwrite(Pessoas[i].IP, sizeof(char),strlen(Pessoas[i].IP), arqIS_Cidade);
        fprintf(arqIS_Cidade, "\n");
        // ---------------------------- Nome Fortemente ligado ---------------------------------------------------------
        fwrite(Pessoas[i].nome, sizeof(char),strlen(Pessoas[i].nome), arqIS_Nome);
        fprintf(arqIS_Nome,"|");
        fprintf(arqIS_Nome,"%d\n",Pessoas[i].RRN);

        i++;
    }
    fclose(arqIS_Cidade);
    fclose(arqIS_Nome);
};

void ListarTodos(CadOrder *Order){
    FILE *arqCad;
    arqCad= fopen("C://Users/Lucas/Documents/Clion/Pc_Indexacao/cadastro.txt", "r");

    qsort(Order, 500, sizeof(CadOrder), compararNome); // Ordena os Nomes Por ordem alfabetica

    int k=0;
    char str1[76];
    char c;
    int count=0;

    while (k<500) {
        fseek(arqCad,0,SEEK_SET);//define o ponteiro do arquivo para seu incio
        while (feof(arqCad) == 0) {
            //printf("%s      Indice:%d\n", Order[i].nome, Order[i].RRN);
            c = fgetc(arqCad);
            if (c=='\n'){
                count++;
            }
            if (count== Order[k].RRN){
                fgets(str1,76,arqCad);
                printf("%s\n", str1);
                break;
            }
        }
        count=0;
        k++;
    }
    fclose(arqCad);
};

void PesquisaNome(){
    printf("Pesquisou nome\n");
};

void PesquisaCidade(){
    printf("Pesquisou Cidade\n");
};

void PrintaNomes(CadOrder *Order) {
    int i=0;
    while (i < 500) {
        printf("NOME %d: %s \n",i, Order[i].nome);
        i++;
    }
}

int main() {

//----------------------------------- ABRIR O ARQ DE CADASTRO ----------------------------------------------------------
    FILE *arqread;
    arqread= fopen("C://Users/Lucas/Documents/Clion/Pc_Indexacao/cadastro.txt", "r");
    if (arqread == NULL ){
        printf("ERRO AO ABRIR ARQUIVO DE CADASTROS! \n");
        exit(1);
    }
//------------------------------------ ADICIONAR CADASTROS A RAM -------------------------------------------------------
    CadOrder Order[500];

    cad Pessoas[10];
    int indice=0;
    int cont = 0;

    while (feof(arqread) == 0) { //Percorre o arquivo
        while (cont < 10){// Pega os cadastros de 10 em 10

            fgets(Pessoas[cont].ID,4, arqread); //Pega o ID
            fgets(Pessoas[cont].nome,26, arqread); //Pega o nome
            LIMPAR(Pessoas[cont].nome);
            fgets(Pessoas[cont].rua,26, arqread); //Pega a rua e numero
            LIMPAR(Pessoas[cont].rua);
            fgets(Pessoas[cont].cidade,21, arqread); //Pega a cidade
            LIMPAR(Pessoas[cont].cidade);
            fgets(Pessoas[cont].UF,4, arqread); //Pega a UF
            Pessoas[cont].UF[strcspn(Pessoas[cont].UF, "\n")]='\0'; //REMOVER \n
            LIMPAR(Pessoas[cont].UF);
            Pessoas[cont].RRN= indice; // Cria indice(RRN)

            strncpy(Order[indice].nome, Pessoas[cont].nome, 26); // ENVIA TODOS OS NOMES PARA A ORDENACAO
            Order[indice].RRN= Pessoas[cont].RRN;   //ENVIA TODOS OS RRN PARA ORDENACAO

            indice++;
            cont++;
        }

        CriarIndicePrimario(Pessoas);   //FUNCAO PARA CRIAR INDICES DOS CADASTROS EM RAM
        CriarIndiceSecundario(Pessoas); //FUNCAO PARA CRIAR INDICES DOS CADASTROS EM RAM

        cont = 0;   //Reset cont
        free(Pessoas);  //Limpa Struct
    }
    fclose(arqread);


    //------------------------------------- OPCOES DO MENU -------------------------------------------------------------
    int menu;
    do{
        printf("======== Amigos do Apolonio =======");
        printf("\n1 - Listar todos os dados dos amigos ");
        printf("\n2 - Pesquisar por nome");
        printf("\n3 - Pesquisar por cidade");
        printf("\n4 - Sair do programa");
        printf("\nDigite sua opcao: ");
        scanf("%i", &menu);

        if (menu != 1 && menu != 2 && menu != 3 && menu != 4 ){
            printf("\n\nOPCAO INVALIDA\n\n");
        }

        switch(menu){
            case 1:
                ListarTodos(Order);

                break;
            case 2:
                PesquisaNome();
                break;
            case 3:
                PesquisaCidade();
                break;
            case 4:
                break;
        }
    }while(menu != 4);

    return 0;
}
